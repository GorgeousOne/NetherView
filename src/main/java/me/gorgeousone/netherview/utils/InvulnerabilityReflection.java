package me.gorgeousone.netherview.utils;

import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.scheduler.BukkitRunnable;

import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

public class InvulnerabilityReflection {
	
	private static String VERSION;
	private static Method GET_HANDLE;
	private static Field PLAYER_ABILITIES;
	private static Field IS_INVULNERABLE;
	
	static {
		
		try {
			VERSION = Bukkit.getServer().getClass().getPackage().getName().replace(".", ",").split(",")[3] + ".";
			GET_HANDLE = getCraftBukkitClass("entity.CraftPlayer").getMethod("getHandle");
			PLAYER_ABILITIES = getNMSClass("EntityPlayer").getField("abilities");
			IS_INVULNERABLE = getNMSClass("PlayerAbilities").getField("isInvulnerable");
			
		} catch (NoSuchMethodException | ClassNotFoundException | NoSuchFieldException e) {
			e.printStackTrace();
		}
	}
	
	public static void setTemporarilyInvulnerable(Player player, JavaPlugin plugin, long duration) {
		
		try {
			Object nmsPlayer = GET_HANDLE.invoke(player);
			Object playerAbilities = PLAYER_ABILITIES.get(nmsPlayer);
			
			IS_INVULNERABLE.setBoolean(playerAbilities, true);
			
			new BukkitRunnable() {
				@Override
				public void run() {
					
					try {
						IS_INVULNERABLE.setBoolean(playerAbilities, false);
					} catch (IllegalAccessException e) {
						e.printStackTrace();
					}
				}
			}.runTaskLater(plugin, duration);
			
		} catch (SecurityException | IllegalArgumentException | IllegalAccessException | InvocationTargetException e) {
			e.printStackTrace();
		}
	}
	
	private static Class<?> getNMSClass(String nmsClassString) throws ClassNotFoundException {
		return Class.forName("net.minecraft.server." + VERSION + nmsClassString);
	}
	
	private static Class<?> getCraftBukkitClass(String cbClassString) throws ClassNotFoundException {
		return Class.forName("org.bukkit.craftbukkit." + VERSION + cbClassString);
	}
}
