package me.gorgeousone.netherview.utils;

import org.bukkit.entity.Player;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.scheduler.BukkitRunnable;

import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;

public final class InvulnerabilityUtils {
	
	private InvulnerabilityUtils() {}
	
	private static Field PLAYER_ABILITIES;
	private static Field IS_INVULNERABLE;
	
	static {
		
		try {
			PLAYER_ABILITIES = NmsUtils.getNmsClass("EntityPlayer").getField("abilities");
			IS_INVULNERABLE = NmsUtils.getNmsClass("PlayerAbilities").getField("isInvulnerable");
			
		} catch (ClassNotFoundException | NoSuchFieldException e) {
			e.printStackTrace();
		}
	}
	
	public static void setTemporarilyInvulnerable(Player player, JavaPlugin plugin, long duration) {
		
		try {
			Object nmsPlayer = NmsUtils.getHandle(player);
			Object playerAbilities = PLAYER_ABILITIES.get(nmsPlayer);
			IS_INVULNERABLE.setBoolean(playerAbilities, true);
			
			new BukkitRunnable() {
				@Override
				public void run() {
					
					try {
						IS_INVULNERABLE.setBoolean(playerAbilities, false);
					} catch (IllegalAccessException e) {
						e.printStackTrace();
					}
				}
			}.runTaskLater(plugin, duration);
			
		} catch (SecurityException | IllegalArgumentException | IllegalAccessException | InvocationTargetException e) {
			e.printStackTrace();
		}
	}
}